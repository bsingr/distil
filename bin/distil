#!/usr/bin/env ruby

module Distil

  LIB_DIR= File.expand_path(File.join(File.dirname(__FILE__), "..", "lib"))
  VENDOR_DIR= File.expand_path(File.join(File.dirname(__FILE__), "..", "vendor"))
  ASSETS_DIR= File.expand_path(File.join(File.dirname(__FILE__), "..", "assets"))
  APP_NAME= File.basename($0)
  APP_SCRIPT= $0
  
  $:.unshift(LIB_DIR)

  require 'distil'

  help = <<-HELP
  Distil is a tool for building HTML applications from its component CSS & Javascript files.

  HELP

  require 'optparse'

  options = {}
  opts = OptionParser.new do |opts|
    opts.banner = help

    opts.on("--server [PORT]", "Start web server (default port 8888)") do |port|
      options['server'] = true
      options['server_port'] = port unless port.nil?
    end
    
    opts.on("--base URL", "The base path for the server") do |url|
      options['url']= url
    end
  end
  opts.parse!
  
  project= Project.find(Dir.pwd)
  unless project
    puts "#{APP_NAME}: Could not find project to build"
    exit 1
  end

  puts "\n#{project.name}:\n\n"
  commands= ARGV.empty? ? ['build'] : ARGV
  commands.each { |cmd|
    project.send cmd
  }
  project.report
  
  if true==options['server']
    start_server(project, options)
  end
  
end
